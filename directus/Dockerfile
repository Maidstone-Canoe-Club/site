FROM node:18-alpine AS builder

WORKDIR /builder

COPY package.json ./
COPY extensions/ extensions/

RUN npm i && npm run build

FROM directus/directus:10.5

USER node
WORKDIR /directus

# COPY . .
COPY snapshots/ ./snapshots
COPY extensions/templates/ ./extensions/templates
COPY --from=builder /builder/extensions/directus-extension-slugify ./extensions/directus-extension-slugify
COPY --from=builder /builder/extensions/directus-extension-mcc ./extensions/directus-extension-mcc

ARG DB_CLIENT
ARG DB_HOST
ARG DB_PORT
ARG DB_DATABASE
ARG DB_USER
ARG DB_PASSWORD
ARG ADMIN_EMAIL
ARG ADMIN_PASSWORD
ARG KEY
ARG SECRET
ARG PUBLIC_URL
ARG CACHE_ENABLED
ARG CACHE_AUTO_PURGE
ARG EMAIL_SMTP_HOST
ARG EMAIL_SMTP_PORT
ARG EMAIL_SMTP_USER
ARG EMAIL_SMTP_PASSWORD
ARG EMAIL_DOMAIN
ARG SENTRY_DSN

ENV DB_CLIENT ${DB_CLIENT}
ENV DB_HOST ${DB_HOST}
ENV DB_PORT ${DB_PORT}
ENV DB_DATABASE ${DB_DATABASE}
ENV DB_USER ${DB_USER}
ENV DB_PASSWORD ${DB_PASSWORD}
ENV ADMIN_EMAIL ${ADMIN_EMAIL}
ENV ADMIN_PASSWORD ${ADMIN_PASSWORD}
ENV KEY ${KEY}
ENV SECRET ${SECRET}
ENV PUBLIC_URL ${PUBLIC_URL}
ENV CACHE_ENABLED ${CACHE_ENABLED}
ENV CACHE_AUTO_PURGE ${CACHE_AUTO_PURGE}
ENV EMAIL_SMTP_HOST ${EMAIL_SMTP_HOST}
ENV EMAIL_SMTP_PORT ${EMAIL_SMTP_PORT}
ENV EMAIL_SMTP_USER ${EMAIL_SMTP_USER}
ENV EMAIL_SMTP_PASSWORD ${EMAIL_SMTP_PASSWORD}
ENV EMAIL_DOMAIN ${EMAIL_DOMAIN}
ENV SENTRY_DSN ${SENTRY_DSN}

ARG PORT
ENV PORT ${PORT}
EXPOSE ${PORT}

CMD npx directus bootstrap && \
    npx directus schema apply snapshots/latest.yml --yes && \
    npx directus start
