FROM node:22-bullseye-slim AS prebase

RUN apt-get update && apt-get install -y --no-install-recommends netcat wget ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /mcc

RUN npm i -g --force corepack && corepack enable

COPY package.json pnpm-lock.yaml .npmrc ./

FROM prebase AS base

RUN pnpm i --frozen-lockfile

ARG NUXT_PUBLIC_DIRECTUS_URL
ENV NUXT_PUBLIC_DIRECTUS_URL ${NUXT_PUBLIC_DIRECTUS_URL}

ARG NUXT_PUBLIC_UMAMI_HOST
ENV NUXT_PUBLIC_UMAMI_HOST ${NUXT_PUBLIC_UMAMI_HOST}

ARG NUXT_PUBLIC_UMAMI_ID
ENV NUXT_PUBLIC_UMAMI_ID ${NUXT_PUBLIC_UMAMI_ID}

ARG SENTRY_DSN
ENV SENTRY_DSN ${SENTRY_DSN}

ARG SENTRY_ENVIRONMENT
ENV SENTRY_ENVIRONMENT ${SENTRY_ENVIRONMENT}

ARG SENTRY_RELEASE
ENV SENTRY_RELEASE ${SENTRY_RELEASE}

ARG SENTRY_AUTH_TOKEN
ENV SENTRY_AUTH_TOKEN ${SENTRY_AUTH_TOKEN}

ARG SENTRY_ORG
ENV SENTRY_ORG ${SENTRY_ORG}

ARG SENTRY_PROJECT
ENV SENTRY_PROJECT ${SENTRY_PROJECT}

ARG STRIPE_KEY
ENV STRIPE_KEY ${STRIPE_KEY}

ARG STRIPE_WEBHOOK_SECRET
ENV STRIPE_WEBHOOK_SECRET ${STRIPE_WEBHOOK_SECRET}

ARG NUXT_TURNSTILE_SECRET_KEY
ENV NUXT_TURNSTILE_SECRET_KEY ${NUXT_TURNSTILE_SECRET_KEY}

ARG NUXT_PUBLIC_TURNSTILE_SITE_KEY
ENV NUXT_PUBLIC_TURNSTILE_SITE_KEY ${NUXT_PUBLIC_TURNSTILE_SITE_KEY}

ARG BASE_URL
ENV BASE_URL ${BASE_URL}

ENV PORT 3000
ENV NITRO_PORT 3000
ENV HOST 0.0.0.0
EXPOSE 3000

FROM base AS build

WORKDIR /mcc
COPY --from=base --chown=node:node /mcc .

COPY ./app ./app
COPY ./public ./public
COPY ./server ./server
COPY ./nuxt.config.ts ./
COPY ./tailwind.config.ts ./
COPY ./tsconfig.json ./

RUN pnpm build

RUN rm -rf node_modules && rm -rf .nuxt

FROM prebase

USER node

WORKDIR /mcc
COPY --from=build --chown=node:node /mcc/.output ./.output

ARG BASE_URL
ENV BASE_URL ${BASE_URL}

ARG SENTRY_DSN
ENV SENTRY_DSN ${SENTRY_DSN}

ARG SENTRY_ENVIRONMENT
ENV SENTRY_ENVIRONMENT ${SENTRY_ENVIRONMENT}

ARG SENTRY_RELEASE
ENV SENTRY_RELEASE ${SENTRY_RELEASE}

ARG SENTRY_AUTH_TOKEN
ENV SENTRY_AUTH_TOKEN ${SENTRY_AUTH_TOKEN}

ARG SENTRY_ORG
ENV SENTRY_ORG ${SENTRY_ORG}

ARG SENTRY_PROJECT
ENV SENTRY_PROJECT ${SENTRY_PROJECT}

ARG OPENAI_API_KEY
ENV OPENAI_API_KEY ${OPENAI_API_KEY}

ENV NODE_ENV production
ENV HOST 0.0.0.0

CMD ["node", ".output/server/index.mjs"]
